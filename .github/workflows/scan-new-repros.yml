# Internal workflow
# Force refresh for GitHub Actions cache
name: "[Internal] Scan for New Reproductions"

on:
  workflow_dispatch:
    inputs:
      api_url:
        description: 'Pruva API URL'
        required: false
        default: 'https://pruva-api-production.up.railway.app/v1'

jobs:
  scan-and-create-branches:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Configure git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Fetch all reproductions and create branches
        env:
          API_URL: ${{ inputs.api_url }}
        run: |
          echo "Fetching reproductions from $API_URL..."

          # Fetch all reproductions (paginated)
          REPROS=$(curl -sf "$API_URL/reproductions?status=published&limit=1000" | jq -r '.reproductions[].repro_id')

          if [ -z "$REPROS" ]; then
            echo "No reproductions found or API error"
            exit 1
          fi

          echo "Found reproductions:"
          echo "$REPROS"
          echo ""

          CREATED=0
          FIXED=0
          SKIPPED=0

          for REPRO_ID in $REPROS; do
            BRANCH="repro/$REPRO_ID"

            # Check if branch exists and if it's properly configured
            if git ls-remote --heads origin "$BRANCH" | grep -q "$BRANCH"; then
              # Branch exists - check if REPRO_ID is set correctly
              CURRENT_ID=$(curl -sf "https://raw.githubusercontent.com/N3mes1s/pruva-sandbox/$BRANCH/.devcontainer/devcontainer.json" | grep '"REPRO_ID"' | grep -o 'REPRO-[0-9]\{4\}-[0-9]\{5\}' || echo "")

              if [ "$CURRENT_ID" = "$REPRO_ID" ]; then
                echo "SKIP: $BRANCH already configured correctly"
                SKIPPED=$((SKIPPED + 1))
                continue
              fi

              echo "FIX: $BRANCH (current: ${CURRENT_ID:-empty}, expected: $REPRO_ID)"

              # Checkout existing branch and fix it
              git fetch origin "$BRANCH:$BRANCH"
              git checkout "$BRANCH"

              # Update devcontainer.json to set correct REPRO_ID
              sed -i "s/\"REPRO_ID\": \"[^\"]*\"/\"REPRO_ID\": \"$REPRO_ID\"/" .devcontainer/devcontainer.json

              # Commit and force-push fix
              git add .devcontainer/devcontainer.json
              git commit -m "fix: set REPRO_ID=$REPRO_ID for this branch" \
                -m "Co-Authored-By: GitHub Actions <github-actions[bot]@users.noreply.github.com>"
              git push --force-with-lease origin "$BRANCH"

              FIXED=$((FIXED + 1))

              # Return to main
              git checkout main
              continue
            fi

            echo "CREATE: $BRANCH"

            # Create branch from main
            git checkout -b "$BRANCH" origin/main

            # Update devcontainer.json to set REPRO_ID
            sed -i "s/\"REPRO_ID\": \"\"/\"REPRO_ID\": \"$REPRO_ID\"/" .devcontainer/devcontainer.json

            # Commit changes
            git add .devcontainer/devcontainer.json
            git commit -m "chore: set REPRO_ID=$REPRO_ID for this branch" \
              -m "Co-Authored-By: GitHub Actions <github-actions[bot]@users.noreply.github.com>"

            # Push branch
            git push origin "$BRANCH"

            CREATED=$((CREATED + 1))

            # Return to main for next iteration
            git checkout main
          done

          echo ""
          echo "=========================================="
          echo "Summary:"
          echo "  Created: $CREATED"
          echo "  Fixed: $FIXED"
          echo "  Skipped: $SKIPPED"
          echo "=========================================="

          if [ $CREATED -eq 0 ] && [ $FIXED -eq 0 ]; then
            echo "No changes needed - all branches are correctly configured"
          fi
